name: ðŸ“¦ Publish Bzlmod Snapshot Release

on:
  push:
    branches:
      - "**" # è§¦å‘æ‰€æœ‰åˆ†æ”¯çš„pushäº‹ä»¶
    tags:
      - "v*"
      - "snapshot-*"

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å…è®¸ gh cli åˆ›å»º release

    steps:
      - name: 1. ðŸ Checkout Repository
        uses: actions/checkout@v4

      - name: 2. ðŸ·ï¸ Generate Release Tag and Module Name
        id: generate_tag
        run: |
          # ç”Ÿæˆæ—¥æœŸ+hashæ ¼å¼çš„tag: snapshot-YYYYMMDD-shortSHA
          DATE=$(date +%Y%m%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG_NAME="snapshot-${DATE}-${SHORT_SHA}"

          # ä»Ž github.repository (æ ¼å¼: owner/repo) ä¸­æå– repo åç§°
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          echo "Generated tag: $TAG_NAME"
          echo "Module name: $REPO_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "module_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: 3. ðŸ“¦ Create Source Tarball
        id: package
        run: |
          TAR_NAME="${{ steps.generate_tag.outputs.tag_name }}.tar.gz"
          echo "Creating tarball: $TAR_NAME..."

          # åˆ›å»º tarballï¼ˆæŽ’é™¤ .git å’Œ .githubï¼‰
          tar --exclude=.git \
              --exclude=.github \
              -czvf "../$TAR_NAME" .

          # å°† tarball ç§»å›žå½“å‰ç›®å½•
          mv "../$TAR_NAME" .

          echo "tar_name=$TAR_NAME" >> $GITHUB_OUTPUT

      - name: 4. ðŸ§® Calculate Bzlmod Integrity Hash
        id: sha
        run: |
          TAR_NAME="${{ steps.package.outputs.tar_name }}"
          SHA_NAME="${TAR_NAME}.sha256"

          # è®¡ç®— Bzlmod æœŸæœ›çš„ sha256-base64 æ ¼å¼
          BASE64_HASH=$(sha256sum "$TAR_NAME" | cut -d' ' -f1 | xxd -r -p | base64 -w0)
          INTEGRITY_STRING="sha256-${BASE64_HASH}"

          echo "Calculated Integrity: $INTEGRITY_STRING"
          echo "$INTEGRITY_STRING" > "$SHA_NAME"

          echo "integrity_string=$INTEGRITY_STRING" >> $GITHUB_OUTPUT
          echo "sha_name=$SHA_NAME" >> $GITHUB_OUTPUT

      - name: 5. ðŸ“ Generate MODULE.bazel with archive_override for tarball
        id: generate_override
        run: |
          # Generate archive_override version
          python3 .github/workflows/convert_to_archive_override.py > MODULE.bazel.new

          # Keep original for reference
          cp MODULE.bazel MODULE.bazel.git_override

          # Replace MODULE.bazel in tarball with archive_override version
          mv MODULE.bazel.new MODULE.bazel

          # Also create MODULE.bazel.override for standalone download
          cp MODULE.bazel MODULE.bazel.override

          echo "override_file=MODULE.bazel.override" >> $GITHUB_OUTPUT
          echo "git_override_file=MODULE.bazel.git_override" >> $GITHUB_OUTPUT

      - name: 6. ðŸ“¦ Re-create Tarball with archive_override MODULE.bazel
        id: repackage
        run: |
          TAR_NAME="${{ steps.package.outputs.tar_name }}"
          echo "Re-creating tarball with archive_override MODULE.bazel..."

          # Remove old tarball
          rm "$TAR_NAME"

          # Create new tarball with updated MODULE.bazel
          tar --exclude=.git \
              --exclude=.github \
              --exclude=MODULE.bazel.git_override \
              -czvf "../$TAR_NAME" .

          # Move tarball back
          mv "../$TAR_NAME" .

      - name: 7. ðŸ§® Recalculate Integrity Hash
        id: resha
        run: |
          TAR_NAME="${{ steps.package.outputs.tar_name }}"
          SHA_NAME="${TAR_NAME}.sha256"

          # Recalculate integrity for new tarball
          BASE64_HASH=$(sha256sum "$TAR_NAME" | cut -d' ' -f1 | xxd -r -p | base64 -w0)
          INTEGRITY_STRING="sha256-${BASE64_HASH}"

          echo "Updated Integrity: $INTEGRITY_STRING"
          echo "$INTEGRITY_STRING" > "$SHA_NAME"

      - name: 8. ðŸš€ Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get updated integrity hash
          INTEGRITY_STRING=$(cat "${{ steps.package.outputs.tar_name }}.sha256")

          # å‡†å¤‡ Release Notes
          NOTES=$(cat <<EOF
          Automated release for commit \`${{ github.sha }}\`.

          ---

          ### ðŸ“¦ What's Included

          This release provides a **production-ready** rules_hdl snapshot with \`archive_override\` for faster CI builds.

          - **Tarball**: Contains \`MODULE.bazel\` with \`archive_override\` for tools without submodules
          - **Integrity Hash**: SHA256 integrity for Bazel bzlmod
          - **MODULE.bazel.override**: Same as tarball's MODULE.bazel (for reference)
          - **MODULE.bazel.git_override**: Original MODULE.bazel with \`git_override\` (for development)

          ### ðŸš€ Usage in Your Project

          \`\`\`bzl
          bazel_dep(name = "rules_hdl", version = "0.0.1")
          archive_override(
              module_name = "rules_hdl",
              urls = ["https://github.com/${{ github.repository }}/releases/download/${{ steps.generate_tag.outputs.tag_name }}/${{ steps.package.outputs.tar_name }}"],
              integrity = "${INTEGRITY_STRING}",
          )
          \`\`\`

          ### ðŸ”§ What's Optimized

          - âœ… Tools **without** submodules use \`archive_override\` (faster CI):
            \`swig\`, \`iverilog\`, \`icestorm\`, \`abc\`, \`ncurses\`, \`lemon\`, \`p7zip\`, \`cxxopts\`, \`tcl\`, \`llvm-project\`, \`openroad\`

          - âš ï¸  Tools **with** submodules still use \`git_override\` (pending CI):
            \`yosys\`, \`nextpnr\`, \`prjtrellis\`

          ### ðŸ“ For Development

          If you want git_override for development, download \`MODULE.bazel.git_override\` and use it as \`MODULE.bazel\`.
          EOF
          )

          # å¦‚æžœ release å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤å®ƒ
          echo "Checking if release ${{ steps.generate_tag.outputs.tag_name }} already exists..."
          gh release delete ${{ steps.generate_tag.outputs.tag_name }} --yes --cleanup-tag 2>/dev/null || echo "Release does not exist, continuing..."

          # åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
          gh release create ${{ steps.generate_tag.outputs.tag_name }} \
              --notes "$NOTES" \
              --title "Snapshot ${{ steps.generate_tag.outputs.tag_name }}" \
              "${{ steps.package.outputs.tar_name }}" \
              "${{ steps.sha.outputs.sha_name }}" \
              "${{ steps.generate_override.outputs.override_file }}" \
              "${{ steps.generate_override.outputs.git_override_file }}"

          echo "âœ… Release created successfully!"
