name: ðŸ“¦ Publish Bzlmod Snapshot Release

on:
  push:
    branches:
      - "**" # è§¦å‘æ‰€æœ‰åˆ†æ”¯çš„pushäº‹ä»¶
    tags:
      - "v*"
      - "snapshot-*"

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å…è®¸ gh cli åˆ›å»º release

    steps:
      - name: 1. ðŸ Checkout Repository
        uses: actions/checkout@v4

      - name: 2. ðŸ·ï¸ Generate Release Tag and Module Name
        id: generate_tag
        run: |
          # ç”Ÿæˆæ—¥æœŸ+hashæ ¼å¼çš„tag: snapshot-YYYYMMDD-shortSHA
          DATE=$(date +%Y%m%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG_NAME="snapshot-${DATE}-${SHORT_SHA}"

          # ä»Ž github.repository (æ ¼å¼: owner/repo) ä¸­æå– repo åç§°
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          echo "Generated tag: $TAG_NAME"
          echo "Module name: $REPO_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "module_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: 3. ðŸ“¦ Create Source Tarball
        id: package
        run: |
          TAR_NAME="${{ steps.generate_tag.outputs.tag_name }}.tar.gz"
          echo "Creating tarball: $TAR_NAME..."

          # åˆ›å»º tarballï¼ˆæŽ’é™¤ .git å’Œ .githubï¼‰
          tar --exclude=.git \
              --exclude=.github \
              -czvf "../$TAR_NAME" .

          # å°† tarball ç§»å›žå½“å‰ç›®å½•
          mv "../$TAR_NAME" .

          echo "tar_name=$TAR_NAME" >> $GITHUB_OUTPUT

      - name: 4. ðŸ§® Calculate Bzlmod Integrity Hash
        id: sha
        run: |
          TAR_NAME="${{ steps.package.outputs.tar_name }}"
          SHA_NAME="${TAR_NAME}.sha256"

          # è®¡ç®— Bzlmod æœŸæœ›çš„ sha256-base64 æ ¼å¼
          BASE64_HASH=$(sha256sum "$TAR_NAME" | cut -d' ' -f1 | xxd -r -p | base64 -w0)
          INTEGRITY_STRING="sha256-${BASE64_HASH}"

          echo "Calculated Integrity: $INTEGRITY_STRING"
          echo "$INTEGRITY_STRING" > "$SHA_NAME"

          echo "integrity_string=$INTEGRITY_STRING" >> $GITHUB_OUTPUT
          echo "sha_name=$SHA_NAME" >> $GITHUB_OUTPUT

      - name: 5. ðŸ“ Generate MODULE.bazel.override with archive_override
        id: generate_override
        run: |
          OVERRIDE_FILE="MODULE.bazel.override"
          python3 .github/workflows/convert_to_archive_override.py > "$OVERRIDE_FILE"
          echo "override_file=$OVERRIDE_FILE" >> $GITHUB_OUTPUT

      - name: 6. ðŸš€ Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å‡†å¤‡ Release Notes
          NOTES=$(cat <<EOF
          Automated release for commit \`${{ github.sha }}\`.

          ---

          ### ðŸŽ¯ For Development (git_override)

          Use the regular \`MODULE.bazel\` file in the repository for development.

          ### ðŸš€ For Production/CI (archive_override)

          Download and use \`MODULE.bazel.override\` from this release for faster CI builds:

          \`\`\`bash
          # Replace your MODULE.bazel with the archive_override version
          curl -L "https://github.com/${{ github.repository }}/releases/download/${{ steps.generate_tag.outputs.tag_name }}/MODULE.bazel.override" > MODULE.bazel
          \`\`\`

          Or reference this rules_hdl snapshot:

          \`\`\`bzl
          archive_override(
              module_name = "rules_hdl",
              urls = ["https://github.com/${{ github.repository }}/releases/download/${{ steps.generate_tag.outputs.tag_name }}/${{ steps.package.outputs.tar_name }}"],
              integrity = "${{ steps.sha.outputs.integrity_string }}",
          )
          \`\`\`

          **Note:** Some tools with git submodules (yosys, nextpnr, prjtrellis) still use git_override.
          For full archive-only builds, those tools need their own CI releases.
          EOF
          )

          # å¦‚æžœ release å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤å®ƒ
          echo "Checking if release ${{ steps.generate_tag.outputs.tag_name }} already exists..."
          gh release delete ${{ steps.generate_tag.outputs.tag_name }} --yes --cleanup-tag 2>/dev/null || echo "Release does not exist, continuing..."

          # åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
          gh release create ${{ steps.generate_tag.outputs.tag_name }} \
              --notes "$NOTES" \
              --title "Snapshot ${{ steps.generate_tag.outputs.tag_name }}" \
              "${{ steps.package.outputs.tar_name }}" \
              "${{ steps.sha.outputs.sha_name }}" \
              "${{ steps.generate_override.outputs.override_file }}"

          echo "âœ… Release created successfully!"
